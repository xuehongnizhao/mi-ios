
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="renderer" content="webkit">
<meta http-equiv="Cache-Control" content="no-siteapp" />
<title>Insert title here</title>
<script src="js/include.js"></script>
<link>
<style type="text/css">

.am-header .am-header-title {
margin: 0 15%;
}

.mi-black {
	color: #4489ce;
	background: white;
	outline: none;
	border: white 1px solid;
	border-top: #dddddd 1px solid;
}

.bk {
	border-bottom: 1px solid #eeeeee;
}

.row_height {
	height: 3.6em;
	line-height: 3.6em;
}

.honor, .item {
	padding-left: 1em;
	padding-right: 1em;
	padding-bottom: 0.5em;
}

.bcolor {
	background-color: #ffffff;
}

label {
	
}

.am-form-group {
	margin-bottom: 0em;
	padding-top: 0.5em;
	padding-bottom: 0.5em;
	background: #fbfef1;
	line-height: 2em;
}

.am-form-group .am-u-sm-10 {
	margin: 0em;
	padding: 0em;
	padding-left: 1em;
}

.am-form-group .am-u-sm-2 {
	padding-left: 1em;
	padding-right: 0em;
}

.am-form-group .am-u-sm-2 input {
	border: none;
	outline: none;
	color: #a4a2a2;
}

.am-form-group .am-u-sm-2 input[readonly] {
	background-color: #fbfef1;
}

.am-form-group .am-u-sm-10 input {
	border: 0px;
	outline: none;
	padding-right: 1em;
	border-color: transparent;
	color: #a4a2a2;
	float:right;
	text-align: right;
	margin-top: 5px;
}
.am-form-group .am-u-sm-8 input {
	border: 0px;
	outline: none;
	padding-right: 1em;
	border-color: transparent;
	color: #333333;
	float:right;
	text-align: right;
	margin-top: 5px;
	background-color: #fbfef1;
}


.am-form-group .am-u-sm-10 input:focus {
	-webkit-box-shadow: none;
	box-shadow: none;
}

.am-form-group  textarea:focus {
	-webkit-box-shadow: none;
	box-shadow: none;
}

.am-form-group .am-u-sm-10 input[readonly] {
	background-color: #fbfef1;
}

hr {
	margin: 0em;
	padding: 0em;
	border-top: 1px solid #dddddd;
}

.hr-left {
	margin-left: 1em;
}

.margin {
	margin: 0em;
}

body, html {
	width: 100%;
	height: 100%;
	background-image: url('img/mi_bg.png');
	background-size: cover;
	background-repeat: no-repeat;
}
.mi-title {
	background-color: #5b3914;
}
input[name=edit-name] {
	border: 1px solid #eee;
	line-height: 2em;
	height: 2em;
	background: transparent;
	width: 130px;
	outline: none;
	text-align: center;
}
input[name=edit-mobile] {
	border: 1px solid #eee;
	line-height: 2em;
	height: 2em;
	background: transparent;
	width: 130px;
	outline: none;
	text-align: center;
}
.am-btn-secondary {
    color: #4489ce;
    background-color: white;
    border-color: white;
}
</style>
</head>
<body style="">

	<!-- Header -->
	<header data-am-widget="header" style=""
		class="am-header am-header-default am-header-fixed mi-title">
		<div class="am-header-left am-header-nav">
			<a href="javascript:mi_exit(-1);" style="text-align: left"> <i
				class="am-icon-angle-left" style="font-size: 2em;"></i>
			</a>
		</div>
		<h1 class="am-header-title"
			style="font-size: 18px; text-align: left; margin: 0 10%;">账户管理</h1>
	</header>
    <div style="background:#e1e6d2">
        <div class="am-form-group am-g" style=" height:5em">
               <div class="am-u-sm-2" style="margin-top: 1em;">
				<input type="text" value="头像" readonly>
			   </div>
			   <div class="am-u-sm-10">
               <i class="am-icon-angle-right" style="font-size: 1.5em;float: right;color:#aaaaaa;margin-right: 10px;margin-top: 10px;"></i>
			   <img id="userIcon" class="am-img-thumbnail am-circle" src="" onerror="this.src='img/morentou.png'"
				        style="border:1px solid #999999;padding:3px;height:4em;margin-top: 0.2em;float: right;margin-right: 10px;"/>
               </div>		  
		 </div>
		 <hr class="hr-left">      
		<div class="am-form-group am-g">
			<div class="am-u-sm-2">
				<input type="text" value="用户名" readonly>
			</div>
			<div class="am-u-sm-10">
				<input type="text" id="user-nickname" placeholder="请输入你的姓名" name="uname" readonly style="">				
			</div>			
		</div>
		 <hr class="hr-left">      
		<div class="am-form-group am-g">
			<div class="am-u-sm-2">
				<input type="text" value="昵称"  readonly >
			</div>
			<div class="am-u-sm-10">
				<i class="am-icon-angle-right" style="font-size: 1.5em;float: right;color:#aaaaaa;margin-right: 10px;"></i>
				<span id="user-name"  name="uname" style="float: right;margin-right: 10px;color: #a4a2a2"></span>				
			</div>			
		</div>
		<hr class="hr-left">
		<div class="am-form-group am-g">
			<div class="am-u-sm-2">
				<input type="text" value="性别" readonly>
			</div>
			<div class="am-u-sm-10 " id="sex-group">
				<i class="am-icon-angle-right" style="font-size: 1.5em;float: right;color:#aaaaaa;margin-right: 10px;"></i>
				<input type="text" id="user-sex" name="sex" readonly>				
			</div>
		</div>
		<hr class="hr-left">
		
		<div class="am-form-group am-g">
			<div class="am-u-sm-2">
				<input type="text" value="生日:" readonly>
			</div>
			<div class="am-u-sm-10">
				<i class="am-icon-angle-right" style="font-size: 1.5em;float: right;color:#aaaaaa;margin-right: 10px;"></i>	
				<input id="user-birth" type="text" class="" name="birth"
					onclick="showDateDialog();" data-am-datepicker readonly style="width: 60%;" />
			</div>
		</div>	
	</div>
	
	<div style="background:#e1e6d2; margin-top: 10px;">
		<div class="am-form-group am-g">
			<div class="am-u-sm-4">
				<input type="text" value="联系方式" readonly style="background: #fbfef1;border: none;color: #a4a2a2">
			</div>
			<div class="am-u-sm-8 " id="sex-group" style="padding-right: 0px">
			    <input type="text" id="user-mobile"  name="mobile" readonly style="float: right;margin-right: 10px;color: #a4a2a2">	
				<!--  <span id="user-mobile"  name="mobile" style="float: right;margin-right: 10px;color: #a4a2a2"></span>	-->		
			</div>
		</div>
		<hr class="hr-left">
		<div class="am-form-group am-g" onclick="addrList()">
			<div class="am-u-sm-4">
				<input type="text" value="地址管理" readonly style="background: #fbfef1;border: none;color: #a4a2a2">
			</div>
			<div class="am-u-sm-8" style="padding-right: 0px">
				<i class="am-icon-angle-right" style="font-size: 1.5em;float: right;color:#aaaaaa;margin-right: 10px;"></i>								
			</div>
		</div>			
	</div>
	
	<div class="am-modal am-modal-confirm" tabindex="-1"
		id="modify-name">
		<div class="am-modal-dialog">
			<div class="am-modal-hd">请输入您的昵称</div>
			<div class="am-modal-bd">
				<input name='edit-name'>
			</div>
			<div class="am-modal-footer">
				<span class="am-modal-btn" data-am-modal-cancel>取消</span> <span
					class="am-modal-btn" data-am-modal-confirm>确定</span>
			</div>
		</div>
	</div>
	<!--  
	<div class="am-modal am-modal-confirm" tabindex="-1"
		id="modify-mobile">
		<div class="am-modal-dialog">
			<div class="am-modal-hd">修改联系方式</div>
			<div class="am-modal-bd">
				<input name='edit-mobile' maxlength="11" 
					onkeyup="this.value=this.value.replace(/\D/g,'')">					
			</div>
			<div class="am-modal-footer">
				<span class="am-modal-btn" data-am-modal-cancel>取消</span> <span
					class="am-modal-btn" data-am-modal-confirm>确定</span>
			</div>
		</div>
	</div>
	-->
	<div class="am-modal-actions" id="select_icon">
		<div class="am-modal-actions-group margin">
			<ul class="am-list">
				<li style="height: 3em; line-height: 3em;"
					onclick="uploadUserIcon(1)"><span>拍照上传</span></li>
				<li style="height: 3em; line-height: 3em;"
					onclick="uploadUserIcon(2)"><span>相册上传</span></li>
				<li onclick="closemodal('#select_icon')" ><button class="mi-black" data-am-modal-cancel
						style="height: 3em; width: 100%; border: none;">取消</button></li>
			</ul>
		</div>
	</div>

	<div class="am-modal-actions" id="input_xb">
		<div class="am-modal-actions-group margin">
			<ul class="am-list">
				<li style = "height:3em;line-height:3em;" val="男" data-am-modal-confirm><span>男</span></li>
				<li style = "height:3em;line-height:3em;" val="女" data-am-modal-confirm><span>女</span></li>
				<li><button class="am-btn am-btn-secondary am-btn-block"
						data-am-modal-cancel style = "height:3em;">取消</button></li>
			</ul>
		</div>
	</div>

</body>
<script type="text/javascript">
	var userid = window.localStorage.getItem("userid");
	var token = window.localStorage.getItem('token');
	var isLogin = true;
	$('#user-sex').on('click', function() {
		$('#input_xb').modal({
			relatedTarget : this,
			onConfirm : function(e) {
				$('#user-sex').val(e.trigger.getAttribute("val"));
				updateperInfo("sex", e.trigger.getAttribute("val"));
				$('#input_xb').modal('close');
			},
			onCancel : function(e) {
				$('#input_xb').modal('close');
			}

		});
	});

	function showDateDialog() {
		$('#user-birth').datepicker().
	    on('changeDate.datepicker.amui', function(event) {
	    	updateperInfo("birth",$('#user-birth').val().trim());
	      
	    });
	}



	jQuery(document).ready(function() {
		getperInfo();
		$('#user-name').on("click",modifyUserName);
	});
	var modifyBuyNumSpan;
	function modifyUserName (){
		modifyBuyNumSpan = this;
		$('#modify-name').modal({
			relatedTarget : this,
			onConfirm : modifyConfirm,
			// closeOnConfirm: false,
			onCancel : function() {
			}
		});
	}
	function modifyConfirm(){
		var name = $('input[name="edit-name"]').val();
		modifyBuyNumSpan.textContent = name;
		updateperInfo("uname", name);
	}
	/*var modifyMoble;
	function modifyUserMobile (){
		modifyBuyNumSpan = this;
		$('#modify-mobile').modal({
			relatedTarget : this,
			onConfirm : modifyMbile,
			// closeOnConfirm: false,
			onCancel : function() {
			}
		});
	}
	function modifyMbile(){
		var num = $('input[name="edit-mobile"]').val();
		//modifyMoble.textContent = num;
		$('#user-mobile').html(num);
		updateperInfo("mobile", num);
	}
	*/
	
	function getperInfo() {
		//var uid = '20731ea0c5984e59a27f4167fc46930e';//6267c41208444ee4b0f9b6261b5920f0--20731ea0c5984e59a27f4167fc46930e
		
		$.ajax({
			type : "post",
			url : url("MyPage.perinfo&u=" + userid+"&t="+token),
			dataType : "jsonp",
			jsonp : "callback",
			jsonpCallback : "pinfo",
			success : function(json) {
				if(!checktoken(json)){
	        		return; 
	        	}
				var per = json.pinfo[0];
				$('#userIcon').attr('src', json.pinfo[0].icon);
				$('#user-nickname').val(per.nickname == 'null' ? "" : per.nickname);
				$('#user-name').html(per.uname == 'null' ? "" : per.uname);
				$('#user-sex').val(per.sex == 'null' ? "" : per.sex);
				$('#user-birth').val(per.birth == 'null' ? "" : per.birth);
				$('#user-mobile').val(per.birth == 'null' ? "" : per.mobile);
			},
			error : function() {
			}
		});

	}

	function updateperInfo(key ,value) {
		//var uid = '20731ea0c5984e59a27f4167fc46930e';//6267c41208444ee4b0f9b6261b5920f0--20731ea0c5984e59a27f4167fc46930e
		var murl = url("MyPage.updatePerInfo&u=" + userid);
		murl +="&t=" + window.localStorage.getItem('token');
		murl +="&key=" + key;
		murl += "&value=" + value;
	//	murl += "&sex=" + $('#user-sex').val().trim();
		//murl += "&birth=" + $('#user-birth').val().trim();

		murl = encodeURI(murl);
		murl = encodeURI(murl);

		$.ajax({
			type : "post",
			url : murl,
			dataType : "jsonp",
			jsonp : "callback",
			jsonpCallback : "update",
			success : function(json) {
				if(!checktoken(json)){
	        		return; 
	        	}
				if (json.update > 0) {
					
				} else {
					showalert("保存失败");
				}
			},
			error : function() {
				showalert("网络异常，请稍后重试");
			}
		});

	}
	
	function updateUserIconData(imgpath) {
		console.log("upload method " + imgpath);
		var m = url("MyPage.updateUserIcon&u=" + userid + "&t=" + token
				+ "&path=" + $('#userIcon').attr('src'));
		console.log("upload method url =  " + m);
		$.ajax({
			type : "post",
			url : m,
			dataType : "jsonp",
			jsonp : "callback",
			jsonpCallback : "uinfo",
			success : function(json) {
				console.log("upload succ ");
				SpinnerPlugin.activityStop();
			},
			error : function() {
				console.log("upload failed ");
				SpinnerPlugin.activityStop();
			}
		});
	}

	$('#userIcon').click(function() {
		$('#select_icon').modal();
	});

	function uploadUserIcon(type) {
		$('#select_icon').modal('close');
		var sourceType;
		if (type == 1) {
			sourceType = navigator.camera.PictureSourceType.CAMERA;
		} else if (type == 2) {
			sourceType = navigator.camera.PictureSourceType.PHOTOLIBRARY;
		} else {
			return;
		}
		navigator.camera.getPicture(uploadPhoto, function(message) {
			navigator.notification.alert("获取图片失败", function(){}, "提示", "确定");
		}, {
			quality : 50,
			destinationType : navigator.camera.DestinationType.FILE_URI,
			sourceType : sourceType,
			allowEdit : true,
			aspectX : 1,
			aspectY : 1
		});

	}

	function uploadPhoto(imageURI) {
		var options = new FileUploadOptions();
		options.fileKey = "file";
		options.fileName = imageURI.substr(imageURI.lastIndexOf('/') + 1);
		//options.mimeType="image/jpeg";
		options.mimeType = "multipart/form-data";
		options.chunkedMode = false;
		//options.enctype="multipart/form-data"
		var params = {};
		params.value1 = "test";
		params.value2 = imageURI;

		options.params = params;

		var ft = new FileUpload();
		ft.onprogress = function(progressEvt) {//显示上传进度条
			if (progressEvt.lengthComputable) {
				SpinnerPlugin
						.activityStart("上传进度："
								+ Math
										.round((progressEvt.loaded / progressEvt.total) * 100)
								+ "%");
			}
		}
		ft.upload(imageURI, encodeURI(surl("upload")), win, fail, options);
		SpinnerPlugin.activityStart("开始上传...");
	}

	function win(r) {
		console.log("Code = " + r.responseCode);
		console.log("Response = " + r.response);
		console.log("Sent = " + r.bytesSent);
		var imgpath = surl("img/" + r.response);
		$("#userIcon").attr('src', imgpath);
		updateUserIconData(imgpath);
	}

	function fail(error) {
		navigator.notification.alert("An error has occurred: Code = " + error.code, function(){}, "提示", "确定");
		console.log("upload error source " + error.source);
		console.log("upload error target " + error.target);
		SpinnerPlugin.activityStop();
	}
	function addrList() {
		if (isLogin) {
			window.location.href = "addrlist.html";
		} else {
			window.location.href = "login.html";
		}
	}
	function closemodal(id) {
		$(id).modal('close');
	}
</script>
</html>
